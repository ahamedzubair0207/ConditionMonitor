/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Component, ContentChild, ElementRef, EventEmitter, Input, Output, TemplateRef, ViewChild, ViewContainerRef, } from '@angular/core';
import { AtlasPopupDirective } from '../directives/atlas-popup.directive';
import { LoadMapService } from '../utils/load-map.service';
export class AtlasMapComponent {
    /**
     * @param {?} mapService
     */
    constructor(mapService) {
        this.mapService = mapService;
        this.onMapClick = new EventEmitter();
        this.loaded = new EventEmitter();
        this.customPins = [];
        this.features = [];
        this.pointsArray = [];
        this.cssArray = [];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.popupAtlas = new atlas.Popup();
        this.mapService.loadedComponenet.next(true);
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        this.createMap(this._id, this.initialConfig); // Initial map
        this.startMapClickListener(); // Start emitter
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.emitLoaded();
    }
    /**
     * @return {?}
     */
    emitLoaded() {
        if (this.map) {
            this.loaded.emit();
        }
        else {
            setTimeout(this.emitLoaded, 100);
        }
    }
    /**
     * @param {?} id
     * @param {?} config
     * @return {?}
     */
    createMap(id, config) {
        try {
            this.mapWrapper.nativeElement.setAttribute('id', id);
            this.map = new atlas.Map(id, config); // Init map box
            console.log('Map was created!', this.map);
        }
        catch (e) {
            console.log('CHECK YOUR CONFIG!', e);
        }
    }
    /**
     * @param {?} options
     * @return {?}
     */
    changeMapCamera(options) {
        this.map.setCamera(options);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    changeMapStyle(options) {
        this.map.setStyle(options);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    changeUserInteraction(options) {
        this.map.setUserInteraction(options);
    }
    /**
     * Founding all unique layers from features Array
     * @param {?} features
     * @return {?} string[]
     */
    findUniqueLayers(features) {
        /** @type {?} */
        const allLayers = features.map(it => it.layer);
        return Array.from(new Set(allLayers));
    }
    /**
     * @return {?}
     */
    startMapClickListener() {
        this.map.addEventListener('click', (e) => {
            this.onMapClick.emit(e.position);
            // On click you emit geo position
        });
    }
    /**
     * Creating popUpContainer and injected to parent Template
     * @param {?} context
     * @return {?}
     */
    createComponent(context) {
        if (this.popupView) {
            this.popupView.destroy();
        }
        this.popupView = this.popupsContainer.createEmbeddedView(this.popupTemplate, context);
    }
    /**
     * @param {?} id
     * @param {?} loc
     * @param {?} clas
     * @return {?}
     */
    addItem(id, loc, clas) {
        /** @type {?} */
        let customHTML;
        /** @type {?} */
        const idItem = clas + id;
        /** @type {?} */
        const pos = new atlas.data.Position(loc.lnt, loc.lng);
        this.cssArray.push(idItem); // Saving existing HTML elements
        customHTML = document.createElement('div');
        customHTML.setAttribute('id', idItem);
        customHTML.setAttribute('class', clas);
        this.map.addHtml(customHTML, pos); // add to map
    }
    /**
     * Drawin point on the map as pins
     * \@Incjet createPopups()
     * @param {?} features
     * @return {?}
     */
    createPoints(features) {
        if (features.length === 0) {
            console.log('No data available');
            return;
        }
        for (const item of features) {
            this.map.addPins([item.atlasFeature], item.pinConfig);
            if (item.atlasFeature.properties.cssClass) {
                this.addItem(item.dataElement.id, item.dataElement.localization, item.atlasFeature.properties.cssClass);
                this.customPins.push(item.atlasFeature.properties.cssClass);
            }
            this.pointsArray.push(item.atlasFeature);
        }
        this.createPopups(features);
    }
    /**
     * Created popUps for all features by type of layers
     * Adding event on 'mouseover'
     * @param {?} features
     * @return {?}
     */
    createPopups(features) {
        for (const item of this.findUniqueLayers(features)) {
            if (this.popupTemplate) {
                this.map.addEventListener('mouseover', item, (e) => {
                    /** @type {?} */
                    const amFeature = features.find(it => it.dataElement.name === e.features[0].properties.name);
                    this.createComponent({
                        /**
                                     * sent to template variable
                                     * raw data from input
                                     */
                        dataElement: amFeature.dataElement
                    });
                    this.popupAtlas.setPopupOptions({
                        position: e.features[0].geometry.coordinates,
                        content: document.getElementById(`popupWrapper`),
                    });
                    this.popupAtlas.open(this.map);
                });
            }
        }
    }
    /**
     * @param {?} features
     * @return {?}
     */
    updatePoints(features) {
        this.map.removeLayers(this.findUniqueLayers(features));
        if (this.cssArray.length) {
            this.cssArray.forEach(value => {
                (/** @type {?} */ (document.querySelectorAll(`#${value}`))).forEach(it => it.remove());
                this.map.removeHtml(value);
            });
            this.cssArray = [];
        }
        this.createPoints(features);
    }
    /**
     * @return {?}
     */
    removeMap() {
        this.map.remove();
    }
}
AtlasMapComponent.decorators = [
    { type: Component, args: [{
                selector: 'am-map',
                template: `<div #mapWrapper class="atlas-map"></div>

<div id="popupWrapper">
  <div #popupsContainer>
  </div>
</div>




`,
                styles: [`.atlas-map{position:relative;width:100%;height:100%}`]
            },] },
];
/** @nocollapse */
AtlasMapComponent.ctorParameters = () => [
    { type: LoadMapService }
];
AtlasMapComponent.propDecorators = {
    initialConfig: [{ type: Input }],
    _id: [{ type: Input }],
    onMapClick: [{ type: Output }],
    loaded: [{ type: Output }],
    popupsContainer: [{ type: ViewChild, args: ['popupsContainer', { read: ViewContainerRef },] }],
    mapWrapper: [{ type: ViewChild, args: ['mapWrapper', { read: ElementRef },] }],
    popupTemplate: [{ type: ContentChild, args: [AtlasPopupDirective, { read: TemplateRef },] }]
};
if (false) {
    /** @type {?} */
    AtlasMapComponent.prototype.initialConfig;
    /** @type {?} */
    AtlasMapComponent.prototype._id;
    /** @type {?} */
    AtlasMapComponent.prototype.onMapClick;
    /** @type {?} */
    AtlasMapComponent.prototype.loaded;
    /** @type {?} */
    AtlasMapComponent.prototype.popupsContainer;
    /** @type {?} */
    AtlasMapComponent.prototype.mapWrapper;
    /**
     * For create and control popup
     * To Inject into ng-template in parent
     * @type {?}
     */
    AtlasMapComponent.prototype.popupTemplate;
    /** @type {?} */
    AtlasMapComponent.prototype.popupView;
    /** @type {?} */
    AtlasMapComponent.prototype.popupAtlas;
    /** @type {?} */
    AtlasMapComponent.prototype.map;
    /** @type {?} */
    AtlasMapComponent.prototype.customPins;
    /** @type {?} */
    AtlasMapComponent.prototype.features;
    /** @type {?} */
    AtlasMapComponent.prototype.pointsArray;
    /** @type {?} */
    AtlasMapComponent.prototype.cssArray;
    /** @type {?} */
    AtlasMapComponent.prototype.mapService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXRsYXMtbWFwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhY2Fpc29mdC9hbmd1bGFyLWF6dXJlLW1hcHMvIiwic291cmNlcyI6WyJzcmMvYXp1cmUtbWFwL2F0bGFzLW1hcC9hdGxhcy1tYXAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSxPQUFPLEVBR0wsU0FBUyxFQUNULFlBQVksRUFDWixVQUFVLEVBRVYsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBQ04sV0FBVyxFQUNYLFNBQVMsRUFDVCxnQkFBZ0IsR0FDakIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0scUNBQXFDLENBQUM7QUFDeEUsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBaUJ6RCxNQUFNOzs7O0lBMEJKLFlBQW9CLFVBQTBCO1FBQTFCLGVBQVUsR0FBVixVQUFVLENBQWdCOzBCQXJCdkIsSUFBSSxZQUFZLEVBQXVCO3NCQUN4QixJQUFJLFlBQVksRUFBRTswQkFldkIsRUFBRTt3QkFDSixFQUFFOzJCQUNXLEVBQUU7d0JBQ2pCLEVBQUU7S0FHOUI7Ozs7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUU3Qzs7OztJQUVELGtCQUFrQjtRQUNoQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0tBQzlCOzs7O0lBRUQsZUFBZTtRQUNiLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztLQUNuQjs7OztJQUVELFVBQVU7UUFDUixJQUFJLElBQUksQ0FBQyxHQUFH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O0tBQ25COzs7WUFsTUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxRQUFRO2dCQUNsQixRQUFRLEVBQUU7Ozs7Ozs7Ozs7Q0FVWDtnQkFDQyxNQUFNLEVBQUUsQ0FBQyxzREFBc0QsQ0FBQzthQUNqRTs7OztZQWhCTyxjQUFjOzs7NEJBa0JuQixLQUFLO2tCQUNMLEtBQUs7eUJBR0wsTUFBTTtxQkFDTixNQUFNOzhCQUVOLFNBQVMsU0FBQyxpQkFBaUIsRUFBRSxFQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBQzt5QkFDckQsU0FBUyxTQUFDLFlBQVksRUFBRSxFQUFDLElBQUksRUFBRSxVQUFVLEVBQUM7NEJBTTFDLFlBQVksU0FBQyxtQkFBbUIsRUFBRSxFQUFDLElBQUksRUFBRSxXQUFXLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vLi4vYXRsYXNcIi8+XG5cbmltcG9ydCB7XG4gIEFmdGVyQ29udGVudEluaXQsXG4gIEFmdGVyVmlld0luaXQsXG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkLFxuICBFbGVtZW50UmVmLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NoaWxkLFxuICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QW1GZWF0dXJlfSBmcm9tICcuLi9pbnRlcmZhY2VzL2FtLWZlYXR1cmUnO1xuaW1wb3J0IHtBdGxhc1BvcHVwRGlyZWN0aXZlfSBmcm9tICcuLi9kaXJlY3RpdmVzL2F0bGFzLXBvcHVwLmRpcmVjdGl2ZSc7XG5pbXBvcnQge0xvYWRNYXBTZXJ2aWNlfSBmcm9tICcuLi91dGlscy9sb2FkLW1hcC5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYW0tbWFwJyxcbiAgdGVtcGxhdGU6IGA8ZGl2ICNtYXBXcmFwcGVyIGNsYXNzPVwiYXRsYXMtbWFwXCI+PC9kaXY+XG5cbjxkaXYgaWQ9XCJwb3B1cFdyYXBwZXJcIj5cbiAgPGRpdiAjcG9wdXBzQ29udGFpbmVyPlxuICA8L2Rpdj5cbjwvZGl2PlxuXG5cblxuXG5gLFxuICBzdHlsZXM6IFtgLmF0bGFzLW1hcHtwb3NpdGlvbjpyZWxhdGl2ZTt3aWR0aDoxMDAlO2hlaWdodDoxMDAlfWBdXG59KVxuZXhwb3J0IGNsYXNzIEF0bGFzTWFwQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlckNvbnRlbnRJbml0LCBBZnRlclZpZXdJbml0IHtcbiAgQElucHV0KCkgaW5pdGlhbENvbmZpZzogYW55O1xuICBASW5wdXQoKSBfaWQ6IHN0cmluZztcblxuXG4gIEBPdXRwdXQoKSBvbk1hcENsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxhdGxhcy5kYXRhLlBvc2l0aW9uPigpO1xuICBAT3V0cHV0KCkgbG9hZGVkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBAVmlld0NoaWxkKCdwb3B1cHNDb250YWluZXInLCB7cmVhZDogVmlld0NvbnRhaW5lclJlZn0pIHBvcHVwc0NvbnRhaW5lcjogVmlld0NvbnRhaW5lclJlZjtcbiAgQFZpZXdDaGlsZCgnbWFwV3JhcHBlcicsIHtyZWFkOiBFbGVtZW50UmVmfSkgbWFwV3JhcHBlcjogRWxlbWVudFJlZjtcblxuICAvKipcbiAgICogRm9yIGNyZWF0ZSBhbmQgY29udHJvbCBwb3B1cFxuICAgKiBUbyBJbmplY3QgaW50byBuZy10ZW1wbGF0ZSBpbiBwYXJlbnRcbiAgICovXG4gIEBDb250ZW50Q2hpbGQoQXRsYXNQb3B1cERpcmVjdGl2ZSwge3JlYWQ6IFRlbXBsYXRlUmVmfSkgcG9wdXBUZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PjtcblxuICBwdWJsaWMgcG9wdXBWaWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgcHVibGljIHBvcHVwQXRsYXM6IGF0bGFzLlBvcHVwO1xuXG4gIHB1YmxpYyBtYXA6IGF0bGFzLk1hcDtcbiAgcHJpdmF0ZSBjdXN0b21QaW5zOiBBcnJheTxhbnk+ID0gW107XG4gIHB1YmxpYyBmZWF0dXJlczogQW1GZWF0dXJlW10gPSBbXTsgLy8gQXJyYXkgb2Ygb3VycyBwb2ludHMgdG8gYWRkIG9uIG1hcFxuICBwcml2YXRlIHBvaW50c0FycmF5OiBhdGxhcy5kYXRhLkZlYXR1cmVbXSA9IFtdO1xuICBwcml2YXRlIGNzc0FycmF5OiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWFwU2VydmljZTogTG9hZE1hcFNlcnZpY2UpIHtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMucG9wdXBBdGxhcyA9IG5ldyBhdGxhcy5Qb3B1cCgpO1xuICAgIHRoaXMubWFwU2VydmljZS5sb2FkZWRDb21wb25lbmV0Lm5leHQodHJ1ZSk7XG5cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmNyZWF0ZU1hcCh0aGlzLl9pZCwgdGhpcy5pbml0aWFsQ29uZmlnKTsgLy8gSW5pdGlhbCBtYXBcbiAgICB0aGlzLnN0YXJ0TWFwQ2xpY2tMaXN0ZW5lcigpOyAvLyBTdGFydCBlbWl0dGVyXG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy5lbWl0TG9hZGVkKCk7XG4gIH1cblxuICBlbWl0TG9hZGVkKCkge1xuICAgIGlmICh0aGlzLm1hcCkge1xuICAgICAgdGhpcy5sb2FkZWQuZW1pdCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXRUaW1lb3V0KHRoaXMuZW1pdExvYWRlZCwgMTAwKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlTWFwKGlkOiBzdHJpbmcsIGNvbmZpZzogYW55KTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubWFwV3JhcHBlci5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnaWQnLCBpZCk7XG4gICAgICB0aGlzLm1hcCA9IG5ldyBhdGxhcy5NYXAoaWQsIGNvbmZpZyk7IC8vIEluaXQgbWFwIGJveFxuICAgICAgY29uc29sZS5sb2coJ01hcCB3YXMgY3JlYXRlZCEnLCB0aGlzLm1hcCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coJ0NIRUNLIFlPVVIgQ09ORklHIScsIGUpO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZU1hcENhbWVyYShvcHRpb25zOiBDYW1lcmFPcHRpb25zICYgQW5pbWF0aW9uT3B0aW9ucyk6IHZvaWQge1xuICAgIHRoaXMubWFwLnNldENhbWVyYShvcHRpb25zKTtcbiAgfVxuXG4gIGNoYW5nZU1hcFN0eWxlKG9wdGlvbnM6IFN0eWxlT3B0aW9ucyk6IHZvaWQge1xuICAgIHRoaXMubWFwLnNldFN0eWxlKG9wdGlvbnMpO1xuICB9XG5cbiAgY2hhbmdlVXNlckludGVyYWN0aW9uKG9wdGlvbnM6IFVzZXJJbnRlcmFjdGlvbk9wdGlvbnMpOiB2b2lkIHtcbiAgICB0aGlzLm1hcC5zZXRVc2VySW50ZXJhY3Rpb24ob3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogRm91bmRpbmcgYWxsIHVuaXF1ZSBsYXllcnMgZnJvbSBmZWF0dXJlcyBBcnJheVxuICAgKiBAcGFyYW0gQW1GZWF0dXJlW10gZmVhdHVyZXNcbiAgICogQHJldHVybnMgc3RyaW5nW11cbiAgICovXG4gIGZpbmRVbmlxdWVMYXllcnMoZmVhdHVyZXM6IEFtRmVhdHVyZVtdKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGFsbExheWVycyA9IGZlYXR1cmVzLm1hcChpdCA9PiBpdC5sYXllcik7XG4gICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChhbGxMYXllcnMpKTtcbiAgfVxuXG4gIHN0YXJ0TWFwQ2xpY2tMaXN0ZW5lcigpOiB2b2lkIHtcbiAgICB0aGlzLm1hcC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICB0aGlzLm9uTWFwQ2xpY2suZW1pdChlLnBvc2l0aW9uKTtcbiAgICAgIC8vIE9uIGNsaWNrIHlvdSBlbWl0IGdlbyBwb3NpdGlvblxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0aW5nIHBvcFVwQ29udGFpbmVyIGFuZCBpbmplY3RlZCB0byBwYXJlbnQgVGVtcGxhdGVcbiAgICogQHBhcmFtIGNvbnRleHRcbiAgICovXG4gIGNyZWF0ZUNvbXBvbmVudChjb250ZXh0OiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wb3B1cFZpZXcpIHtcbiAgICAgIHRoaXMucG9wdXBWaWV3LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgdGhpcy5wb3B1cFZpZXcgPSB0aGlzLnBvcHVwc0NvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5wb3B1cFRlbXBsYXRlLCBjb250ZXh0KTtcbiAgfVxuXG4gIGFkZEl0ZW0oaWQsIGxvYywgY2xhcyk6IHZvaWQge1xuICAgIGxldCBjdXN0b21IVE1MO1xuICAgIGNvbnN0IGlkSXRlbSA9IGNsYXMgKyBpZDtcbiAgICBjb25zdCBwb3MgPSBuZXcgYXRsYXMuZGF0YS5Qb3NpdGlvbihsb2MubG50LCBsb2MubG5nKTtcbiAgICB0aGlzLmNzc0FycmF5LnB1c2goaWRJdGVtKTsgIC8vIFNhdmluZyBleGlzdGluZyBIVE1MIGVsZW1lbnRzXG5cbiAgICBjdXN0b21IVE1MID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgY3VzdG9tSFRNTC5zZXRBdHRyaWJ1dGUoJ2lkJywgaWRJdGVtKTtcbiAgICBjdXN0b21IVE1MLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjbGFzKTtcblxuICAgIHRoaXMubWFwLmFkZEh0bWwoY3VzdG9tSFRNTCwgcG9zKTsgLy8gYWRkIHRvIG1hcFxuICB9XG5cbiAgLyoqXG4gICAqIERyYXdpbiBwb2ludCBvbiB0aGUgbWFwIGFzIHBpbnNcbiAgICogQEluY2pldCBjcmVhdGVQb3B1cHMoKVxuICAgKiBAcGFyYW0gIGZlYXR1cmVzXG4gICAqL1xuICBjcmVhdGVQb2ludHMoZmVhdHVyZXM6IEFtRmVhdHVyZVtdKTogdm9pZCB7XG4gICAgaWYgKGZlYXR1cmVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc29sZS5sb2coJ05vIGRhdGEgYXZhaWxhYmxlJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGZlYXR1cmVzKSB7XG4gICAgICB0aGlzLm1hcC5hZGRQaW5zKFtpdGVtLmF0bGFzRmVhdHVyZV0sIGl0ZW0ucGluQ29uZmlnKTtcbiAgICAgIGlmIChpdGVtLmF0bGFzRmVhdHVyZS5wcm9wZXJ0aWVzLmNzc0NsYXNzKSB7XG4gICAgICAgIHRoaXMuYWRkSXRlbShpdGVtLmRhdGFFbGVtZW50LmlkLCBpdGVtLmRhdGFFbGVtZW50LmxvY2FsaXphdGlvbiwgaXRlbS5hdGxhc0ZlYXR1cmUucHJvcGVydGllcy5jc3NDbGFzcyk7XG4gICAgICAgIHRoaXMuY3VzdG9tUGlucy5wdXNoKGl0ZW0uYXRsYXNGZWF0dXJlLnByb3BlcnRpZXMuY3NzQ2xhc3MpO1xuICAgICAgfVxuICAgICAgdGhpcy5wb2ludHNBcnJheS5wdXNoKGl0ZW0uYXRsYXNGZWF0dXJlKTtcbiAgICB9XG4gICAgdGhpcy5jcmVhdGVQb3B1cHMoZmVhdHVyZXMpO1xuICB9XG5cblxuICAvKipcbiAgICogQ3JlYXRlZCBwb3BVcHMgZm9yIGFsbCBmZWF0dXJlcyBieSB0eXBlIG9mIGxheWVyc1xuICAgKiBBZGRpbmcgZXZlbnQgb24gJ21vdXNlb3ZlcidcbiAgICogQHBhcmFtIGZlYXR1cmVzXG4gICAqL1xuICBjcmVhdGVQb3B1cHMoZmVhdHVyZXM6IEFtRmVhdHVyZVtdKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHRoaXMuZmluZFVuaXF1ZUxheWVycyhmZWF0dXJlcykpIHtcbiAgICAgIGlmICh0aGlzLnBvcHVwVGVtcGxhdGUpIHtcbiAgICAgICAgdGhpcy5tYXAuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgaXRlbSwgKGUpID0+IHtcbiAgICAgICAgICBjb25zdCBhbUZlYXR1cmU6IEFtRmVhdHVyZSA9IGZlYXR1cmVzLmZpbmQoaXQgPT4gaXQuZGF0YUVsZW1lbnQubmFtZSA9PT0gZS5mZWF0dXJlc1swXS5wcm9wZXJ0aWVzLm5hbWUpO1xuICAgICAgICAgIHRoaXMuY3JlYXRlQ29tcG9uZW50KHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogc2VudCB0byB0ZW1wbGF0ZSB2YXJpYWJsZVxuICAgICAgICAgICAgICogcmF3IGRhdGEgZnJvbSBpbnB1dFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBkYXRhRWxlbWVudDogYW1GZWF0dXJlLmRhdGFFbGVtZW50XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5wb3B1cEF0bGFzLnNldFBvcHVwT3B0aW9ucyh7XG4gICAgICAgICAgICBwb3NpdGlvbjogZS5mZWF0dXJlc1swXS5nZW9tZXRyeS5jb29yZGluYXRlcyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBwb3B1cFdyYXBwZXJgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLnBvcHVwQXRsYXMub3Blbih0aGlzLm1hcCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVBvaW50cyhmZWF0dXJlczogQW1GZWF0dXJlW10pOiB2b2lkIHtcbiAgICB0aGlzLm1hcC5yZW1vdmVMYXllcnModGhpcy5maW5kVW5pcXVlTGF5ZXJzKGZlYXR1cmVzKSk7XG4gICAgaWYgKHRoaXMuY3NzQXJyYXkubGVuZ3RoKSB7XG4gICAgICB0aGlzLmNzc0FycmF5LmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgICAoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChgIyR7dmFsdWV9YCkgYXMgYW55KS5mb3JFYWNoKGl0ID0+IGl0LnJlbW92ZSgpKTtcbiAgICAgICAgdGhpcy5tYXAucmVtb3ZlSHRtbCh2YWx1ZSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuY3NzQXJyYXkgPSBbXTtcbiAgICB9XG4gICAgdGhpcy5jcmVhdGVQb2ludHMoZmVhdHVyZXMpO1xuICB9XG5cbiAgcmVtb3ZlTWFwKCkge1xuICAgIHRoaXMubWFwLnJlbW92ZSgpO1xuICB9XG5cblxufVxuXG5cblxuIl19