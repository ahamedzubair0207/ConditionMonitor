/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { isIphone } from './util';
import { DOCUMENT, isPlatformServer } from '@angular/common';
import { Injectable, Inject, PLATFORM_ID, NgZone } from '@angular/core';
import { merge, fromEvent, throwError, of, interval, BehaviorSubject, EMPTY } from 'rxjs';
import { debounceTime, map, startWith, shareReplay, filter, flatMap, tap, distinctUntilChanged, take, takeUntil } from 'rxjs/operators';
import { FS_FULLSCREEN_REQUEST_EVENTS, FS_FULLSCREEN_EXIT_EVENTS, FS_FULLSCREEN_ELEMENT, FS_FULLSCREEN_CHANGE_EVENTS, FS_FULLSCREEN_ELEMENT_ERROR_EVENTS, FS_FULLSCREEN_ENABLED, FS_FULLSCREEN_ENABLED_FUNC, FS_FULLSCREEN_IOS_POLL_MS, FS_FULLSCREEN_IOS_POLL_ENABLED } from './ng-fullscreen.tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./ng-fullscreen.tokens";
/** @type {?} */
var isKeyTrue = (/**
 * @param {?} platformKeys
 * @return {?}
 */
function (platformKeys) { return (/**
 * @param {?} doc
 * @return {?}
 */
function (doc) {
    return platformKeys.reduce((/**
     * @param {?} acc
     * @param {?} curr
     * @return {?}
     */
    function (acc, curr) { return acc || doc[curr] ? true : false; }), false);
}); });
var ɵ0 = isKeyTrue;
/** @type {?} */
var fullscreenChangeError = (/**
 * @param {?} platformKeys
 * @return {?}
 */
function (platformKeys) { return (/**
 * @param {?} doc
 * @return {?}
 */
function (doc) {
    return merge.apply(void 0, tslib_1.__spread(platformKeys.map((/**
     * @param {?} key
     * @return {?}
     */
    function (key) { return fromEvent(doc, key); })))).pipe(debounceTime(0));
}); });
var ɵ1 = fullscreenChangeError;
/** @type {?} */
var filterAndExecute = (/**
 * @param {?} ref
 * @return {?}
 */
function (ref) { return (/**
 * @param {?} arr
 * @return {?}
 */
function (arr) {
    /** @type {?} */
    var funcStringIdx = arr.findIndex((/**
     * @param {?} a
     * @return {?}
     */
    function (a) { return typeof ref[a] === 'function'; }));
    if (funcStringIdx >= 0) {
        ref[arr[funcStringIdx]]();
    }
}); });
var ɵ2 = filterAndExecute;
/**
 * @record
 */
export function IFloFullscreenService() { }
if (false) {
    /** @type {?} */
    IFloFullscreenService.prototype.fullscreen$;
    /** @type {?} */
    IFloFullscreenService.prototype.isFullscreen$;
    /** @type {?} */
    IFloFullscreenService.prototype.isNotFullscreen;
    /** @type {?} */
    IFloFullscreenService.prototype.exitFullscreen;
    /** @type {?} */
    IFloFullscreenService.prototype.goFullscreen;
    /** @type {?} */
    IFloFullscreenService.prototype.canGoFullscreen;
    /** @type {?} */
    IFloFullscreenService.prototype.fullscreenIsSupported;
    /** @type {?} */
    IFloFullscreenService.prototype.isFullscreen;
}
var FloFullscreenService = /** @class */ (function () {
    // tslint:disable: readonly-array
    function FloFullscreenService(zone, doc, platformId, requestEventKeys, exitEventKeys, elementKeys, changeEventKeys, elementErrorEventKeys, enabledKeys, enabledFunc, iosPollrate, iosPollEnabled) {
        var _this = this;
        this.zone = zone;
        this.doc = doc;
        this.platformId = platformId;
        this.requestEventKeys = requestEventKeys;
        this.exitEventKeys = exitEventKeys;
        this.elementKeys = elementKeys;
        this.changeEventKeys = changeEventKeys;
        this.elementErrorEventKeys = elementErrorEventKeys;
        this.enabledKeys = enabledKeys;
        this.enabledFunc = enabledFunc;
        this.iosPollrate = iosPollrate;
        this.iosPollEnabled = iosPollEnabled;
        this.iOSVideoState = new BehaviorSubject(false);
        this.isFullscreen = (/**
         * @param {?=} doc
         * @return {?}
         */
        function (doc) {
            if (doc === void 0) { doc = _this.doc; }
            return isPlatformServer(_this.platformId) ? false : isKeyTrue(_this.elementKeys)(doc) || _this.iOSVideoState.getValue();
        });
        this.fullscreenError$ = fullscreenChangeError(this.elementErrorEventKeys)(this.doc).pipe(map((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return throwError(e); })));
        this.iosVideoBypass = (/**
         * @param {?} pasthrough
         * @return {?}
         */
        function (pasthrough) { return isIphone() ? ['webkitEnterFullscreen'] : pasthrough; });
        this.extractVideoForIphoneIfRequired = (/**
         * @param {?} element
         * @return {?}
         */
        function (element) { return isIphone() && !(element instanceof HTMLVideoElement)
            ? element.querySelector('video') || element
            : element; });
        this.iosPoller = (/**
         * @return {?}
         */
        function () { return !_this.iosPollEnabled
            ? EMPTY
            : _this.zone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                return interval(_this.iosPollrate).pipe(map((/**
                 * @return {?}
                 */
                function () { return Array.from(((/** @type {?} */ (_this.doc))).querySelectorAll('video')); })), flatMap((/**
                 * @param {?} videoElements
                 * @return {?}
                 */
                function (videoElements) { return merge.apply(void 0, tslib_1.__spread(videoElements.map((/**
                 * @param {?} ve
                 * @return {?}
                 */
                function (ve) { return fromEvent(ve, 'webkitbeginfullscreen').pipe(tap((/**
                 * @return {?}
                 */
                function () { return _this.iOSVideoState.next(true); })), take(1)); })), videoElements.map((/**
                 * @param {?} ve
                 * @return {?}
                 */
                function (ve) { return fromEvent(ve, 'webkitendfullscreen').pipe(tap((/**
                 * @return {?}
                 */
                function () { return _this.iOSVideoState.next(false); })), take(1)); })))); })), takeUntil(_this.iOSVideoState));
            })); });
        this.fullscreen$ = isPlatformServer(this.platformId)
            ? of(false)
            : merge.apply(void 0, tslib_1.__spread(this.changeEventKeys.map((/**
             * @param {?} key
             * @return {?}
             */
            function (key) { return fromEvent(_this.doc, key); })), [this.fullscreenError$,
                this.iosPoller()])).pipe(debounceTime(0), map((/**
             * @return {?}
             */
            function () { return _this.isFullscreen(); })), distinctUntilChanged(), startWith(this.isFullscreen()), shareReplay(1));
        this.fullscreenIsSupported = (/**
         * @param {?=} elm
         * @return {?}
         */
        function (elm) {
            return (isPlatformServer(_this.platformId)
                ? of(false)
                : isKeyTrue(_this.enabledKeys)(_this.doc)
                    ? of(true)
                    : !elm
                        ? of(false)
                        : _this.enabledFunc(elm)).pipe(shareReplay(1));
        });
        this.canGoFullscreen = (/**
         * @param {?=} elm
         * @return {?}
         */
        function (elm) {
            return (isPlatformServer(_this.platformId)
                ? of(false)
                : _this.fullscreenIsSupported(elm)
                    .pipe(flatMap((/**
                 * @param {?} isSupported
                 * @return {?}
                 */
                function (isSupported) { return !isSupported
                    ? of(false)
                    : _this.fullscreen$.pipe(map((/**
                     * @param {?} isfs
                     * @return {?}
                     */
                    function (isfs) { return isfs ? false : true; }))); })))).pipe(shareReplay(1));
        });
        this.isFullscreen$ = this.fullscreen$.pipe(filter((/**
         * @param {?} v
         * @return {?}
         */
        function (v) { return v === true; })));
        this.isNotFullscreen = this.fullscreen$.pipe(filter((/**
         * @param {?} v
         * @return {?}
         */
        function (v) { return v === false; })));
        this.exitFullscreen = (/**
         * @return {?}
         */
        function () { return filterAndExecute(_this.doc)(_this.exitEventKeys); });
        this.goFullscreen = (/**
         * @param {?=} elm
         * @return {?}
         */
        function (elm) {
            if (elm === void 0) { elm = _this.doc.body; }
            return filterAndExecute(elm)(_this.iosVideoBypass(_this.requestEventKeys));
        });
    }
    FloFullscreenService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    FloFullscreenService.ctorParameters = function () { return [
        { type: NgZone },
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: String, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_REQUEST_EVENTS,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_EXIT_EVENTS,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_ELEMENT,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_CHANGE_EVENTS,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_ELEMENT_ERROR_EVENTS,] }] },
        { type: Array, decorators: [{ type: Inject, args: [FS_FULLSCREEN_ENABLED,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [FS_FULLSCREEN_ENABLED_FUNC,] }] },
        { type: Number, decorators: [{ type: Inject, args: [FS_FULLSCREEN_IOS_POLL_MS,] }] },
        { type: Boolean, decorators: [{ type: Inject, args: [FS_FULLSCREEN_IOS_POLL_ENABLED,] }] }
    ]; };
    /** @nocollapse */ FloFullscreenService.ngInjectableDef = i0.defineInjectable({ factory: function FloFullscreenService_Factory() { return new FloFullscreenService(i0.inject(i0.NgZone), i0.inject(i1.DOCUMENT), i0.inject(i0.PLATFORM_ID), i0.inject(i2.FS_FULLSCREEN_REQUEST_EVENTS), i0.inject(i2.FS_FULLSCREEN_EXIT_EVENTS), i0.inject(i2.FS_FULLSCREEN_ELEMENT), i0.inject(i2.FS_FULLSCREEN_CHANGE_EVENTS), i0.inject(i2.FS_FULLSCREEN_ELEMENT_ERROR_EVENTS), i0.inject(i2.FS_FULLSCREEN_ENABLED), i0.inject(i2.FS_FULLSCREEN_ENABLED_FUNC), i0.inject(i2.FS_FULLSCREEN_IOS_POLL_MS), i0.inject(i2.FS_FULLSCREEN_IOS_POLL_ENABLED)); }, token: FloFullscreenService, providedIn: "root" });
    return FloFullscreenService;
}());
export { FloFullscreenService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.iOSVideoState;
    /** @type {?} */
    FloFullscreenService.prototype.isFullscreen;
    /** @type {?} */
    FloFullscreenService.prototype.fullscreenError$;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.iosVideoBypass;
    /** @type {?} */
    FloFullscreenService.prototype.extractVideoForIphoneIfRequired;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.iosPoller;
    /** @type {?} */
    FloFullscreenService.prototype.fullscreen$;
    /** @type {?} */
    FloFullscreenService.prototype.fullscreenIsSupported;
    /** @type {?} */
    FloFullscreenService.prototype.canGoFullscreen;
    /** @type {?} */
    FloFullscreenService.prototype.isFullscreen$;
    /** @type {?} */
    FloFullscreenService.prototype.isNotFullscreen;
    /** @type {?} */
    FloFullscreenService.prototype.exitFullscreen;
    /** @type {?} */
    FloFullscreenService.prototype.goFullscreen;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.doc;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.platformId;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.requestEventKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.exitEventKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.elementKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.changeEventKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.elementErrorEventKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.enabledKeys;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.enabledFunc;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.iosPollrate;
    /**
     * @type {?}
     * @private
     */
    FloFullscreenService.prototype.iosPollEnabled;
}
export { ɵ0, ɵ1, ɵ2 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctZnVsbHNjcmVlbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZsb3Nwb3J0c2luYy9uZy1mdWxsc2NyZWVuLyIsInNvdXJjZXMiOlsic3JjL2NvbW1vbi9uZy1mdWxsc2NyZWVuLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBQ2pDLE9BQU8sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUM1RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQ3ZFLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFjLFVBQVUsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUE7QUFDckcsT0FBTyxFQUNMLFlBQVksRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFDL0Qsb0JBQW9CLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFDdEMsTUFBTSxnQkFBZ0IsQ0FBQTtBQUN2QixPQUFPLEVBQ0wsNEJBQTRCLEVBQUUseUJBQXlCLEVBQUUscUJBQXFCLEVBQzlFLDJCQUEyQixFQUFFLGtDQUFrQyxFQUUvRCxxQkFBcUIsRUFBeUIsMEJBQTBCLEVBQ3hFLHlCQUF5QixFQUFFLDhCQUE4QixFQUMxRCxNQUFNLHdCQUF3QixDQUFBOzs7OztJQUV6QixTQUFTOzs7O0FBQ2IsVUFBQyxZQUFtQzs7OztBQUNsQyxVQUFDLEdBQStCO0lBQzlCLE9BQUEsWUFBWSxDQUFDLE1BQU07Ozs7O0lBQUMsVUFBQyxHQUFHLEVBQUUsSUFBSSxJQUFLLE9BQUEsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENB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SUFDM0UsK0NBQXNGOzs7OztJQUN0RixxREFBa0c7Ozs7O0lBQ2xHLDJDQUEyRTs7Ozs7SUFDM0UsMkNBQThFOzs7OztJQUM5RSwyQ0FBOEQ7Ozs7O0lBQzlELDhDQUF1RSIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgaXNJcGhvbmUgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbidcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgUExBVEZPUk1fSUQsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnXG5pbXBvcnQgeyBtZXJnZSwgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yLCBvZiwgaW50ZXJ2YWwsIEJlaGF2aW9yU3ViamVjdCwgRU1QVFkgfSBmcm9tICdyeGpzJ1xuaW1wb3J0IHtcbiAgZGVib3VuY2VUaW1lLCBtYXAsIHN0YXJ0V2l0aCwgc2hhcmVSZXBsYXksIGZpbHRlciwgZmxhdE1hcCwgdGFwLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgdGFrZSwgdGFrZVVudGlsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJ1xuaW1wb3J0IHtcbiAgRlNfRlVMTFNDUkVFTl9SRVFVRVNUX0VWRU5UUywgRlNfRlVMTFNDUkVFTl9FWElUX0VWRU5UUywgRlNfRlVMTFNDUkVFTl9FTEVNRU5ULFxuICBGU19GVUxMU0NSRUVOX0NIQU5HRV9FVkVOVFMsIEZTX0ZVTExTQ1JFRU5fRUxFTUVOVF9FUlJPUl9FVkVOVFMsIEZ1bGxzY3JlZW5SZXF1ZXN0RXZlbnRzLFxuICBGdWxsc2NyZWVuRXhpdEV2ZW50cywgRnVsbHNjcmVlbkVsZW1lbnRLZXlzLCBGdWxsc2NyZWVuQ2hhbmdlRXZlbnRzLCBGdWxsc2NyZWVuRXJyb3JFdmVudHMsXG4gIEZTX0ZVTExTQ1JFRU5fRU5BQkxFRCwgRnVsbHNjcmVlbkVuYWJsZWRLZXlzLCBGU19GVUxMU0NSRUVOX0VOQUJMRURfRlVOQywgRnVsbHNjcmVlbkVuYWJsZWRGdW5jLFxuICBGU19GVUxMU0NSRUVOX0lPU19QT0xMX01TLCBGU19GVUxMU0NSRUVOX0lPU19QT0xMX0VOQUJMRURcbn0gZnJvbSAnLi9uZy1mdWxsc2NyZWVuLnRva2VucydcblxuY29uc3QgaXNLZXlUcnVlID1cbiAgKHBsYXRmb3JtS2V5czogUmVhZG9ubHlBcnJheTxzdHJpbmc+KSA9PlxuICAgIChkb2M6IEhUTUxEb2N1bWVudCB8IEhUTUxFbGVtZW50KSA9PlxuICAgICAgcGxhdGZvcm1LZXlzLnJlZHVjZSgoYWNjLCBjdXJyKSA9PiBhY2MgfHwgZG9jW2N1cnJdID8gdHJ1ZSA6IGZhbHNlLCBmYWxzZSlcblxuY29uc3QgZnVsbHNjcmVlbkNoYW5nZUVycm9yID1cbiAgKHBsYXRmb3JtS2V5czogUmVhZG9ubHlBcnJheTxzdHJpbmc+KSA9PlxuICAgIChkb2M6IEhUTUxEb2N1bWVudCkgPT5cbiAgICAgIG1lcmdlKC4uLnBsYXRmb3JtS2V5cy5tYXAoa2V5ID0+IGZyb21FdmVudChkb2MsIGtleSkpKS5waXBlKGRlYm91bmNlVGltZSgwKSlcblxuY29uc3QgZmlsdGVyQW5kRXhlY3V0ZSA9XG4gIChyZWY6IEhUTUxFbGVtZW50IHwgSFRNTERvY3VtZW50KSA9PlxuICAgIChhcnI6IFJlYWRvbmx5QXJyYXk8c3RyaW5nPikgPT4ge1xuICAgICAgY29uc3QgZnVuY1N0cmluZ0lkeCA9IGFyci5maW5kSW5kZXgoYSA9PiB0eXBlb2YgcmVmW2FdID09PSAnZnVuY3Rpb24nKVxuICAgICAgaWYgKGZ1bmNTdHJpbmdJZHggPj0gMCkge1xuICAgICAgICByZWZbYXJyW2Z1bmNTdHJpbmdJZHhdXSgpXG4gICAgICB9XG4gICAgfVxuXG5leHBvcnQgaW50ZXJmYWNlIElGbG9GdWxsc2NyZWVuU2VydmljZSB7XG4gIHJlYWRvbmx5IGZ1bGxzY3JlZW4kOiBPYnNlcnZhYmxlPGJvb2xlYW4+XG4gIHJlYWRvbmx5IGlzRnVsbHNjcmVlbiQ6IE9ic2VydmFibGU8Ym9vbGVhbj5cbiAgcmVhZG9ubHkgaXNOb3RGdWxsc2NyZWVuOiBPYnNlcnZhYmxlPGJvb2xlYW4+XG4gIHJlYWRvbmx5IGV4aXRGdWxsc2NyZWVuOiAoKSA9PiB2b2lkXG4gIHJlYWRvbmx5IGdvRnVsbHNjcmVlbjogKGVsbT86IEhUTUxFbGVtZW50IHwgSFRNTERvY3VtZW50KSA9PiB2b2lkXG4gIHJlYWRvbmx5IGNhbkdvRnVsbHNjcmVlbjogKGVsbT86IEhUTUxFbGVtZW50KSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+XG4gIHJlYWRvbmx5IGZ1bGxzY3JlZW5Jc1N1cHBvcnRlZDogKGVsbT86IEhUTUxFbGVtZW50KSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+XG4gIHJlYWRvbmx5IGlzRnVsbHNjcmVlbjogKGVsbU9yRG9jOiBIVE1MRG9jdW1lbnQgfCBIVE1MRWxlbWVudCkgPT4gYm9vbGVhblxufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEZsb0Z1bGxzY3JlZW5TZXJ2aWNlIGltcGxlbWVudHMgSUZsb0Z1bGxzY3JlZW5TZXJ2aWNlIHtcbiAgLy8gdHNsaW50OmRpc2FibGU6IHJlYWRvbmx5LWFycmF5XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jOiBhbnksXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBzdHJpbmcsXG4gICAgQEluamVjdChGU19GVUxMU0NSRUVOX1JFUVVFU1RfRVZFTlRTKSBwcml2YXRlIHJlcXVlc3RFdmVudEtleXM6IEZ1bGxzY3JlZW5SZXF1ZXN0RXZlbnRzW10sXG4gICAgQEluamVjdChGU19GVUxMU0NSRUVOX0VYSVRfRVZFTlRTKSBwcml2YXRlIGV4aXRFdmVudEtleXM6IEZ1bGxzY3JlZW5FeGl0RXZlbnRzW10sXG4gICAgQEluamVjdChGU19GVUxMU0NSRUVOX0VMRU1FTlQpIHByaXZhdGUgZWxlbWVudEtleXM6IEZ1bGxzY3JlZW5FbGVtZW50S2V5c1tdLFxuICAgIEBJbmplY3QoRlNfRlVMTFNDUkVFTl9DSEFOR0VfRVZFTlRTKSBwcml2YXRlIGNoYW5nZUV2ZW50S2V5czogRnVsbHNjcmVlbkNoYW5nZUV2ZW50c1tdLFxuICAgIEBJbmplY3QoRlNfRlVMTFNDUkVFTl9FTEVNRU5UX0VSUk9SX0VWRU5UUykgcHJpdmF0ZSBlbGVtZW50RXJyb3JFdmVudEtleXM6IEZ1bGxzY3JlZW5FcnJvckV2ZW50c1tdLFxuICAgIEBJbmplY3QoRlNfRlVMTFNDUkVFTl9FTkFCTEVEKSBwcml2YXRlIGVuYWJsZWRLZXlzOiBGdWxsc2NyZWVuRW5hYmxlZEtleXNbXSxcbiAgICBASW5qZWN0KEZTX0ZVTExTQ1JFRU5fRU5BQkxFRF9GVU5DKSBwcml2YXRlIGVuYWJsZWRGdW5jOiBGdWxsc2NyZWVuRW5hYmxlZEZ1bmMsXG4gICAgQEluamVjdChGU19GVUxMU0NSRUVOX0lPU19QT0xMX01TKSBwcml2YXRlIGlvc1BvbGxyYXRlOiBudW1iZXIsXG4gICAgQEluamVjdChGU19GVUxMU0NSRUVOX0lPU19QT0xMX0VOQUJMRUQpIHByaXZhdGUgaW9zUG9sbEVuYWJsZWQ6IGJvb2xlYW5cbiAgKSB7IH1cblxuICBwcml2YXRlIHJlYWRvbmx5IGlPU1ZpZGVvU3RhdGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKVxuXG4gIHB1YmxpYyByZWFkb25seSBpc0Z1bGxzY3JlZW4gPSAoZG9jOiBIVE1MRG9jdW1lbnQgfCBIVE1MRWxlbWVudCA9IHRoaXMuZG9jKSA9PlxuICAgIGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSA/IGZhbHNlIDogaXNLZXlUcnVlKHRoaXMuZWxlbWVudEtleXMpKGRvYykgfHwgdGhpcy5pT1NWaWRlb1N0YXRlLmdldFZhbHVlKClcblxuICBwdWJsaWMgcmVhZG9ubHkgZnVsbHNjcmVlbkVycm9yJCA9IGZ1bGxzY3JlZW5DaGFuZ2VFcnJvcih0aGlzLmVsZW1lbnRFcnJvckV2ZW50S2V5cykodGhpcy5kb2MpLnBpcGUobWFwKGUgPT4gdGhyb3dFcnJvcihlKSkpXG5cbiAgcHJpdmF0ZSByZWFkb25seSBpb3NWaWRlb0J5cGFzcyA9IChwYXN0aHJvdWdoOiBzdHJpbmdbXSkgPT4gaXNJcGhvbmUoKSA/IFsnd2Via2l0RW50ZXJGdWxsc2NyZWVuJ10gOiBwYXN0aHJvdWdoXG4gIHB1YmxpYyByZWFkb25seSBleHRyYWN0VmlkZW9Gb3JJcGhvbmVJZlJlcXVpcmVkID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiBpc0lwaG9uZSgpICYmICEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxWaWRlb0VsZW1lbnQpXG4gICAgPyBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJykgfHwgZWxlbWVudFxuICAgIDogZWxlbWVudFxuXG4gIHByaXZhdGUgcmVhZG9ubHkgaW9zUG9sbGVyID0gKCkgPT4gIXRoaXMuaW9zUG9sbEVuYWJsZWRcbiAgICA/IEVNUFRZXG4gICAgOiB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT5cbiAgICAgIGludGVydmFsKHRoaXMuaW9zUG9sbHJhdGUpLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiBBcnJheS5mcm9tKCh0aGlzLmRvYyBhcyBIVE1MRG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwoJ3ZpZGVvJykpKSxcbiAgICAgICAgZmxhdE1hcCh2aWRlb0VsZW1lbnRzID0+IG1lcmdlKFxuICAgICAgICAgIC4uLnZpZGVvRWxlbWVudHMubWFwKHZlID0+IGZyb21FdmVudCh2ZSwgJ3dlYmtpdGJlZ2luZnVsbHNjcmVlbicpLnBpcGUodGFwKCgpID0+IHRoaXMuaU9TVmlkZW9TdGF0ZS5uZXh0KHRydWUpKSwgdGFrZSgxKSkpLFxuICAgICAgICAgIC4uLnZpZGVvRWxlbWVudHMubWFwKHZlID0+IGZyb21FdmVudCh2ZSwgJ3dlYmtpdGVuZGZ1bGxzY3JlZW4nKS5waXBlKHRhcCgoKSA9PiB0aGlzLmlPU1ZpZGVvU3RhdGUubmV4dChmYWxzZSkpLCB0YWtlKDEpKSlcbiAgICAgICAgKSksIHRha2VVbnRpbCh0aGlzLmlPU1ZpZGVvU3RhdGUpKSlcblxuICBwdWJsaWMgcmVhZG9ubHkgZnVsbHNjcmVlbiQgPSBpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZClcbiAgICA/IG9mKGZhbHNlKVxuICAgIDogbWVyZ2UoXG4gICAgICAuLi50aGlzLmNoYW5nZUV2ZW50S2V5cy5tYXAoa2V5ID0+IGZyb21FdmVudCh0aGlzLmRvYywga2V5KSksXG4gICAgICB0aGlzLmZ1bGxzY3JlZW5FcnJvciQsXG4gICAgICB0aGlzLmlvc1BvbGxlcigpKS5waXBlKFxuICAgICAgICBkZWJvdW5jZVRpbWUoMCksXG4gICAgICAgIG1hcCgoKSA9PiB0aGlzLmlzRnVsbHNjcmVlbigpKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgc3RhcnRXaXRoKHRoaXMuaXNGdWxsc2NyZWVuKCkpLFxuICAgICAgICBzaGFyZVJlcGxheSgxKSlcblxuICBwdWJsaWMgcmVhZG9ubHkgZnVsbHNjcmVlbklzU3VwcG9ydGVkID1cbiAgICAoZWxtPzogSFRNTEVsZW1lbnQpID0+XG4gICAgICAoaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpXG4gICAgICAgID8gb2YoZmFsc2UpXG4gICAgICAgIDogaXNLZXlUcnVlKHRoaXMuZW5hYmxlZEtleXMpKHRoaXMuZG9jKVxuICAgICAgICAgID8gb2YodHJ1ZSlcbiAgICAgICAgICA6ICFlbG1cbiAgICAgICAgICAgID8gb2YoZmFsc2UpXG4gICAgICAgICAgICA6IHRoaXMuZW5hYmxlZEZ1bmMoZWxtKSkucGlwZShzaGFyZVJlcGxheSgxKSlcblxuICBwdWJsaWMgcmVhZG9ubHkgY2FuR29GdWxsc2NyZWVuID1cbiAgICAoZWxtPzogSFRNTEVsZW1lbnQpID0+XG4gICAgICAoaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpXG4gICAgICAgID8gb2YoZmFsc2UpXG4gICAgICAgIDogdGhpcy5mdWxsc2NyZWVuSXNTdXBwb3J0ZWQoZWxtKVxuICAgICAgICAgIC5waXBlKGZsYXRNYXAoaXNTdXBwb3J0ZWQgPT4gIWlzU3VwcG9ydGVkXG4gICAgICAgICAgICA/IG9mKGZhbHNlKVxuICAgICAgICAgICAgOiB0aGlzLmZ1bGxzY3JlZW4kLnBpcGUobWFwKGlzZnMgPT4gaXNmcyA/IGZhbHNlIDogdHJ1ZSkpKSkpLnBpcGUoc2hhcmVSZXBsYXkoMSkpXG5cbiAgcHVibGljIHJlYWRvbmx5IGlzRnVsbHNjcmVlbiQgPSB0aGlzLmZ1bGxzY3JlZW4kLnBpcGUoZmlsdGVyKHYgPT4gdiA9PT0gdHJ1ZSkpXG4gIHB1YmxpYyByZWFkb25seSBpc05vdEZ1bGxzY3JlZW4gPSB0aGlzLmZ1bGxzY3JlZW4kLnBpcGUoZmlsdGVyKHYgPT4gdiA9PT0gZmFsc2UpKVxuICBwdWJsaWMgcmVhZG9ubHkgZXhpdEZ1bGxzY3JlZW4gPSAoKSA9PiBmaWx0ZXJBbmRFeGVjdXRlKHRoaXMuZG9jKSh0aGlzLmV4aXRFdmVudEtleXMpXG4gIHB1YmxpYyByZWFkb25seSBnb0Z1bGxzY3JlZW4gPSAoZWxtOiBIVE1MRWxlbWVudCB8IEhUTUxEb2N1bWVudCA9IHRoaXMuZG9jLmJvZHkpID0+XG4gICAgZmlsdGVyQW5kRXhlY3V0ZShlbG0pKHRoaXMuaW9zVmlkZW9CeXBhc3ModGhpcy5yZXF1ZXN0RXZlbnRLZXlzKSlcbn1cbiJdfQ==